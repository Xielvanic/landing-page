<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Network Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
            cursor: pointer;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #ddd;
        }
        
        .nested-table {
            margin-top: 10px;
            margin-left: 20px;
            width: 95%;
        }
        
        .nested-table th,
        .nested-table td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: left;
        }
        
        .nested-table th {
            background-color: #e2e2e2;
        }
    </style>
</head>

<body>
    <header>
        <h1>Home Network Monitor</h1>
    </header>
    <main>
        <h2>Devices</h2>
        <table id="deviceTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">IP Address</th>
                    <th onclick="sortTable(1)">Note</th>
                    <th onclick="sortTable(2)">Hostname</th>
                    <th onclick="sortTable(3)">Type</th>
                    <th onclick="sortTable(4)">OS</th>
                    <th onclick="sortTable(5)">Hosted On</th>
                    <th>Last Ping Status</th>
                    <th>Last Ping Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.ip_address }}</td>
                    <td>{{ item.note }}</td>
                    <td>{{ item.hostname }}</td>
                    <td>{{ item.type }}</td>
                    <td>{{ item.os }}</td>
                    <td>{{ item.hosted_on }}</td>
                    <td>{{ item.last_ping_status or 'N/A' }}</td>
                    <td>{{ item.last_ping_time or 'N/A' }}</td>
                    <td>
                        <button onclick="toggleEditForm('{{ item.id }}')">Edit</button>
                        <button onclick="pingDevice('{{ item.id }}')">Ping</button>
                        <form action="{{ url_for('delete_item', item_id=item.id) }}" method="post" style="display:inline;">
                            <button type="submit">Delete</button>
                        </form>
                    </td>
                </tr>
                <tr id="edit-form-{{ item.id }}" style="display:none;">
                    <td colspan="7">
                        <form action="{{ url_for('edit_item_details', item_id=item.id) }}" method="post">
                            <input type="text" name="ip_address" value="{{ item.ip_address }}" required>
                            <input type="text" name="note" value="{{ item.note }}" required>
                            <input type="text" name="hostname" value="{{ item.hostname }}" required>
                            <select name="type" required>
                                <option value="network" {% if item.type == 'network' %}selected{% endif %}>Network</option>
                                <option value="physical" {% if item.type == 'physical' %}selected{% endif %}>Physical</option>
                                <option value="service" {% if item.type == 'service' %}selected{% endif %}>Service</option>
                                <option value="virtual" {% if item.type == 'virtual' %}selected{% endif %}>Virtual</option>
                            </select>
                            <input type="text" name="os" value="{{ item.os }}" required>
                            <select name="hosted_on" required>
                                <option value="NA" {% if item.hosted_on == 'NA' %}selected{% endif %}>NA</option>
                                {% for host in physical_hosts %}
                                <option value="{{ host.hostname }}" {% if item.hosted_on == host.hostname %}selected{% endif %}>{{ host.hostname }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit">Save</button>
                        </form>
                    </td>
                </tr>
                {% if item.services %}
                <tr>
                    <td colspan="7">
                        <table class="nested-table">
                            <thead>
                                <tr>
                                    <th>Service URL</th>
                                    <th>Port</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in item.services %}
                                <tr>
                                    <td><a href="{{ service.url }}" target="_blank">{{ service.url }}</a></td>
                                    <td>{{ service.port }}</td>
                                    <td>
                                        <form action="{{ url_for('delete_service', item_id=item.id, service_index=loop.index0) }}" method="post" style="display:inline;">
                                            <button type="submit">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td colspan="3">
                                        <form action="{{ url_for('add_service', item_id=item.id) }}" method="post">
                                            <input type="url" name="url" placeholder="Service URL" required>
                                            <input type="number" name="port" placeholder="Port" required>
                                            <button type="submit">Add Service</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                {% endif %} {% endfor %}
            </tbody>
        </table>

        <h2>Add New Device</h2>
        <form action="{{ url_for('add_item') }}" method="post">
            <input type="text" name="ip_address" placeholder="IP Address" required>
            <input type="text" name="note" placeholder="Note" required>
            <input type="text" name="hostname" placeholder="Hostname" required>
            <select name="type" required>
                <option value="network">Network</option>
                <option value="physical">Physical</option>
                <option value="service">Service</option>
                <option value="virtual">Virtual</option>
            </select>
            <input type="text" name="os" placeholder="OS" required>
            <select name="hosted_on" required>
                <option value="NA">NA</option>
                {% for host in physical_hosts %}
                <option value="{{ host.hostname }}">{{ host.hostname }}</option>
                {% endfor %}
            </select>
            <button type="submit">Add Device</button>
        </form>
    </main>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function toggleEditForm(itemId) {
            const form = document.getElementById(`edit-form-${itemId}`);
            if (form) {
                form.style.display = form.style.display === 'none' ? 'table-row' : 'none';
            } else {
                console.error(`Edit form with ID edit-form-${itemId} not found.`);
            }
        }

        function sortTable(columnIndex) {
            const table = document.getElementById("deviceTable");
            const rows = Array.from(table.rows).slice(1);
            const isAscending = table.getAttribute("data-sort-order") === "asc";
            const direction = isAscending ? 1 : -1;

            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].innerText.trim();
                const bText = b.cells[columnIndex].innerText.trim();

                if (columnIndex === 0) { // IP Address column
                    return compareIPAddresses(aText, bText) * direction;
                } else {
                    return aText.localeCompare(bText) * direction;
                }
            });

            rows.forEach(row => table.tBodies[0].appendChild(row));
            table.setAttribute("data-sort-order", isAscending ? "desc" : "asc");
        }

        function compareIPAddresses(ip1, ip2) {
            const ip1Parts = ip1.split('.').map(Number);
            const ip2Parts = ip2.split('.').map(Number);

            for (let i = 0; i < 4; i++) {
                if (ip1Parts[i] !== ip2Parts[i]) {
                    return ip1Parts[i] - ip2Parts[i];
                }
            }
            return 0;
        }

        function confirmDelete(itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                fetch(`/delete_item/${itemId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            console.error('Failed to delete item.');
                        }
                    })
                    .catch(error => console.error('Error deleting item:', error));
            }
        }

        function pingDevice(itemId) {
            fetch(`/ping_device/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(`Device is ${data.reachable ? 'reachable' : 'unreachable'}.`);
                    } else {
                        console.error('Failed to ping device:', data.message);
                    }
                })
                .catch(error => console.error('Error pinging device:', error));
        }
    </script>
</body>

</html>